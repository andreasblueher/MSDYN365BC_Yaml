# File: PrepareEnv.yml

steps:
- powershell: |
   Import-Module NVRAppDevOps -DisableNameChecking
   Import-Module navcontainerhelper -DisableNameChecking

   Invoke-WebRequest -Uri $(SignTool) -UseBasicParsing -Method Get -OutFile "C:\Windows\System32\signtool.exe"

   $pfxUnprotectedBytes = [Convert]::FromBase64String($(CertSecret))
   $pfx = New-Object Security.Cryptography.X509Certificates.X509Certificate2
   $pfx.Import($pfxUnprotectedBytes, $null, [Security.Cryptography.X509Certificates.X509KeyStorageFlags]::Exportable)
   $pfxProtectedBytes = $pfx.Export([Security.Cryptography.X509Certificates.X509ContentType]::Pkcs12, $(CertPwd))
   [IO.File]::WriteAllBytes($(CertFile), $pfxProtectedBytes)

   $Config = Read-ALConfiguration -Path .\ -Password $(UserPwd)
   Write-Host $Config
   $temp = "$(LicenseFile)"
   if ($temp -ne $null)
   {
     $Config | Init-ALEnvironment -Build $True -Password $(UserPwd) -LicenseFile $(LicenseFile)
   }
   else
   {
     $Config | Init-ALEnvironment -Build $True -Password $(UserPwd)
   }

  failOnStderr: true
  displayName: 'Prepare environment'

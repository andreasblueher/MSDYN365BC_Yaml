# File: CompileALApps.yml

parameters:
  ConfigFolder: ''

steps:
- powershell: |
   Import-Module NVRAppDevOps -DisableNameChecking
   Import-Module navcontainerhelper -DisableNameChecking

   $Config = Get-Content (-join($env:ConfigFolder,"\config.json")) | ConvertFrom-JSON

   $Config | Compile-ALProjectTree -OrderedApps (Get-ALAppOrder -AppCollection $Config.AllApps) -PackagesPath $Config.RepoPath -CertPath $Config.CertFile -CertPwd $Config.CertPwd

   $Config.AllApps | % {
    copy-item -Path (Join-Path -Path $Config.RepoPath -ChildPath (-join("*",$_.name,"*.app")) -Resolve) -Destination $env:Build_ArtifactStagingDirectory
    #copy-item -Path (Join-Path -Path $Config.RepoPath -ChildPath 'output' | Join-Path -ChildPath '*.app' -Resolve) -Destination $env:Build_ArtifactStagingDirectory -Filter "*_$($_.TestAppName)_*.app"
   }

  displayName: 'Compile AL Apps'
  env:
    ConfigFolder: ${{ parameters.ConfigFolder }}

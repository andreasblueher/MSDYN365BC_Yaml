# File: InstallAlApps.yml

parameters:
  ConfigFolder: ''

steps:
- powershell: |
   Import-Module NVRAppDevOps -DisableNameChecking
   Import-Module navcontainerhelper -DisableNameChecking

   $Config = Get-Content (-join($env:ConfigFolder,"\config.json")) | ConvertFrom-JSON

   $Apps = @{};
   Foreach($App in $Config.AllApps)
   {
    $Apps.Add($App.name,$App)
   }

   $HelperApps = @{};
   Foreach($HelperApp in $Config.HelperApps)
   {
    $HelperApps.Add($HelperApp.name,$HelperApp)
   }

   $Config | UnPublish-ALAppTree -OrderedApps (Get-ALAppOrder -AppCollection $Apps)
   if ($Config.CertFile) {
     $Config | Publish-ALAppTree -OrderedApps (Get-ALAppOrder -AppCollection $Apps) -PackagesPath $Config.RepoPath
     $Config | Publish-ALAppTree -OrderedApps (Get-ALAppOrder -AppCollection $HelperApps) -PackagesPath $Config.RepoPath
   } else {
     $Config | Publish-ALAppTree -OrderedApps (Get-ALAppOrder -AppCollection $Apps) -PackagesPath $Config.RepoPath -SkipVerification 'true'
     $Config | Publish-ALAppTree -OrderedApps (Get-ALAppOrder -AppCollection $HelperApps) -PackagesPath $Config.RepoPath -SkipVerification 'true'
   }

  displayName: 'Install AL Apps'
  env:
    ConfigFolder: ${{ parameters.ConfigFolder }}

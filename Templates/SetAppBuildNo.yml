# File: SetAppBuildNo.yml
parameters:
  ConfigFolder: ''
  UpdateDevOpsBuildNo: 1

steps:
- powershell: |
   Import-Module NVRAppDevOps -DisableNameChecking
   Import-Module navcontainerhelper -DisableNameChecking

   $Config = Get-Content (-join($env:ConfigFolder,"\config.json")) | ConvertFrom-JSON

   [Version]$version = ($Config.AllApps.version | Sort-Object -Descending)[0]

   $NewVersion = "$($version.Major).$($version.Minor).$($env:BUILD_BUILDID).0"

   write-host "Updating build pipeline no. to $NewVersion"
   write-host "##vso[build.updatebuildnumber]$NewVersion"
   $Config.AllApps | % {
      $AppSetup = Get-Content -Path $_.AppPath -Encoding UTF8 | ConvertFrom-Json
      $AppSetup.version = $NewVersion
      $AppSetup | ConvertTo-Json -Depth 5 -Compress | Set-Content -Path $_.AppPath -Encoding UTF8
      $_.version = $NewVersion
   }

   $Config | ConvertTo-Json -Depth 100 | Out-File (-join($env:ConfigFolder,"\config.json")) -Force

  displayName: 'Set App Build and Revision No.'
  env:
    ConfigFolder: ${{ parameters.ConfigFolder }}
    UpdateDevOpsBuildNo: ${{ parameters.UpdateDevOpsBuildNo }}

# File: CompileALApps.yml

steps:
- powershell: |
   Import-Module NVRAppDevOps -DisableNameChecking
   Import-Module navcontainerhelper -DisableNameChecking
   
   $Config = Get-Content (-join($env:ConfigFolder,"\config.json")) | ConvertFrom-JSON
   
   if ($CertPath) {
     Install-NAVSipCryptoProviderFromNavContainer -containerName $Config.ContainerName
   }
   
   function SortApps($changedApps, $allApps) {
     $sortedApps = @()
     $scanned = @{}
     $changedApps | % {
       #example dependency { "appId": "4805fd15-75a5-46a2-952f-39c1c4eab821", "name": "WeatherLibrary", "publisher": "Microsoft", "version": "1.0.0.0"}
       $apps.dependencies | % {
         if ($_.publisher -eq "Microsoft") {
           continue;
         }
         
         #Could be skipped? else has to be compiled before app
         #if ($scanned.Contains()){}
       }
     }
   }
   
   $Config | Compile-ALProjectTree -OrderedApps (Get-ALBuildOrder $Config.AppCollection) -PackagesPath $Config.RepoPath
   
   $Config.AppCollection | % {
     copy-item -Path (Join-Path $Config.RepoPath '*.app') -Destination $env:Build_ArtifactStagingDirectory -Filter "*_$($_.AppName)_*.app"
     copy-item -Path (Join-Path $Config.RepoPath '*.app') -Destination $env:Build_ArtifactStagingDirectory -Filter "*_$($_.TestAppName)_*.app"
   }
   
  displayName: 'Compile AL Apps'
